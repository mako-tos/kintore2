# 機能仕様書: サーバ基本機能

**機能ブランチ**: `1-server-basic`  
**作成日**: 2025-11-02  
**ステータス**: Draft  
**入力**: サーバ基本機能

## 憲法準拠チェック (Constitution Compliance) ※必須

- **GATE:** このチェックは設計開始前に合格していること（フェーズ0前）
 - **注意**: 憲法上の必須項目（技術スタック、データストア、デプロイ、シークレット管理、パフォーマンス、アクセシビリティ等）の詳細は `specs/1-server-basic/plan.md` に記載しています。
 - **GATE:** 設計開始前に `plan.md` と `.specify/memory/constitution.md` に基づく準拠を確認してください。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー1 - API起動とヘルスチェック (優先度: P1)

ユーザー（運用担当）はサーバを起動し、ヘルスチェックエンドポイントでサービスの稼働状態を確認できる。

**この優先度の理由**: サービスの可用性確認は最優先の運用要件であるため。

**独立したテスト**: ヘルスチェックエンドポイントに対して HTTP GET を実施し、200 OK と期待JSONが返ることを確認する。

**受け入れシナリオ**:

1. **前提条件** サーバが起動している、**操作** GET /health を実行すると、**結果** {"status":"ok","uptime":<number>} が返る

---

### ユーザーストーリー2 - 設定読み込みと環境分離 (優先度: P1)

運用担当は環境変数に基づき開発/ステージング/本番の設定が切り替わることを期待する。

**独立したテスト**: 環境変数を切り替えた状態でサーバを起動し、想定の設定値（DB接続先、ログレベル等）が適用されることを確認する。

**受け入れシナリオ**:
1. **前提条件** 環境変数が設定されている、**操作** サーバを起動すると、**結果** 指定した環境の設定が反映される

---

### ユーザーストーリー3 - 基本ログとエラーハンドリング (優先度: P2)

開発者はエラー発生時のログが取得でき、エラーが適切にハンドリングされることを期待する。

**独立したテスト**: 故意にエラーを発生させ、ログにエラー情報（スタック、タイムスタンプ、リクエストIDなど）が出力されることを確認する。

**受け入れシナリオ**:
1. **前提条件** 認証不要のテストエンドポイントがある、**操作** エラーを発生させるリクエストを送ると、**結果** 500レスポンスとログ記録が行われる

---

### ユーザーストーリー4 - トレーニングメニューの取得 (優先度: P1)

ユーザーは利用可能なトレーニングメニューの一覧を取得できる。

**独立したテスト**: GET /api/training-menus に対してリクエストを送信し、正しいフォーマットのレスポンスが返ることを確認する。

**受け入れシナリオ**:
1. **前提条件** サーバが起動している、**操作** GET /api/training-menus を実行すると、**結果** トレーニングメニューの配列が返る

---

### ユーザーストーリー5 - トレーニング記録の取得 (優先度: P1)

ユーザーは特定のトレーニングメニューに紐づく記録を取得できる。

**独立したテスト**: GET /api/training-records?menuId=xxx に対してリクエストを送信し、正しいフォーマットのレスポンスが返ることを確認する。

**受け入れシナリオ**:
1. **前提条件** サーバが起動している、**操作** GET /api/training-records を実行すると、**結果** トレーニング記録の配列が返る

---

### エッジケース

- 高負荷時に /health が遅延する場合（TTLやレート制限をどう扱うか）
- 環境変数が未設定の場合のデフォルト挙動

## 要件 *(必須)*

### 機能要件

 - **FR-006**: 本仕様では認証は不要とする（内部/プライベート用途のみ）。
   - 決定: 認証は不要（Option A） — ネットワークレベルのアクセス制御（VPN/VPC等）で保護する前提。
*不明確な要件のマーキング例:*

### 主要エンティティ *(データを扱う機能の場合に含める)*

- **ServiceStatus**: 稼働状態情報（status:string, uptime:number, version:string）
- **Config**: 環境ごとの設定（DB_URL, LOG_LEVEL, NODE_ENV等）

3. 認証の要否はこの仕様で決定済み（認証不要）。

- file: `specs/1-server-basic/data-model.md` を作成してください（テンプレート `.specify/templates/data-model-template.md` をコピーして利用可）。

- 必須定義（例）:
  - ServiceStatus
    - status: string (例: "ok")
    - uptime: number (秒)
    - version: string (例: "1.0.0")

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: /health エンドポイントが 99.9% の稼働率で 200 レスポンスを返す（監視のための指標）
- **SC-002**: 環境変数切替により開発/ステージング/本番の設定が確実に切り替わる（確認手順を用意）
- **SC-003**: 重大なエラー発生時に 95% のケースで適切なエラーハンドリング（適切なHTTPステータスとログ出力）が行われる

## 依存関係 *(必須)*

- 実装固有の技術依存（ランタイム、フレームワーク、ホスティング、データストア等）は `plan.md` に記載しています。例: Supabase や Netlify などのプラットフォーム選定は実装計画で確定してください。

## 仮定

## 実装上の前提

- 実装固有の技術選定（ランタイム、言語、データストア、デプロイ設定など）は `plan.md` に記載します。
- この仕様書は主に WHAT（機能要件）と WHY（目的）に集中し、実装の詳細は `plan.md` を参照してください。

## 次のステップ

1. `specs/1-server-basic/data-model.md` を作成（テンプレートからコピー）
2. `plan.md` を作成して実装タスクとマイグレーション手順を定義
 3. 認証は本仕様で不要と決定済み（内部運用を前提）。公開提供する場合は別途認証設計を行うこと。

---
