# 実装計画: サーバ基本機能

**ブランチ**: `1-server-basic` | **作成日**: 2025-11-02 | **仕様書**: spec.md

## 概要

この計画は `specs/1-server-basic/spec.md` の要件を満たすための実装上の詳細を示します。技術的な選択、デプロイ手順、シークレット管理、パフォーマンス検証などの運用ルールをここに記載します。

## 技術的コンテキスト

**言語/バージョン**: Node.js 22+, TypeScript
**主要依存関係**: Next.js, Pure.css
**ストレージ**: Supabase（Postgres互換）
**テスト**: ユニット/統合/エンドツーエンド（テストカバレッジ80%を目標）
**対象プラットフォーム**: Netlify（プレビュー + 本番デプロイ）
**プロジェクトタイプ**: Webアプリケーション
**パフォーマンス目標**: API応答時間500ms以内, FCP 500ms以内
**制約**:
 - フォント: 游明朝、游ゴシックを使用
 - 言語: 日本語対応を前提
 - シークレット管理: 環境変数（Netlifyの環境変数）で管理

## デプロイメントフロー

1. ブランチを作成して実装を進める
2. 必要なテストを追加し、CIで実行
3. PRを作成し、レビューと自動テストをパスしたらNetlifyのプレビューにデプロイ
4. ステージングで統合テストを実行
5. ステージング合格後に main へマージし、本番へデプロイ

**障害時の扱い**: 3回連続でテストが失敗した場合は `research.md` に問題点を記載しレビューで対応を決定する

## シークレットと環境管理

- すべてのシークレットは環境変数で管理し、コードにハードコードしない
- シークレットのローテーションポリシーをドキュメント化する
- Netlifyの環境変数およびアクセス権を適切に管理

## データソースへのCRUD

### データアクセスパターン

#### トレーニングメニュー
- 全件取得（status=0の有効なメニューのみ）
- キャッシュ戦略：30分のTTLでメモリキャッシュ
- ソート順：name ASC

#### トレーニング記録
- メニューIDによるフィルタリング
- 期間指定（trainingAt）によるフィルタリング
- ページネーション：50件/ページ
- ソート順：trainingAt DESC

#### パフォーマンス最適化
- N+1問題の回避：トレーニング記録取得時にメニュー情報をJOINして取得
- インデックス：
  - TrainingMenu: id, status
  - TrainingRecord: id, trainingMenuId, trainingAt

#### エラーハンドリング
- 存在しないメニューID指定時：404 Not Found
- 無効なページネーションパラメータ：400 Bad Request

### データ作成パターン

#### トレーニングメニュー
- name のみ指定
- idは自動採番
- statusは0固定
- createdAt, updatedAtはシステム日時を設定

#### トレーニング記録
- trainingMenuId, trainingAt, count を指定
- trainingMenuId はTrainingMenuから(status=0)のidを参照する
- idは自動採番
- createdAtはシステム日時を設定

#### エラーハンドリング
- データ不整合の場合：400 Bad Request エラー原因をメッセージで返す

### データ変更パターン

#### トレーニングメニュー
- idが一致したものを更新
- name, statusは指定可能
- createdAt は絶対に変更しない
- updatedAtはシステム日時を設定

#### トレーニング記録
変更はできない

#### エラーハンドリング
- データ不整合の場合：400 Bad Request エラー原因をメッセージで返す

### データ削除パターン

#### トレーニングメニュー
- idが一致したものを更新
- statusを1に変える
- name, createdAt は変更しない
- updatedAtはシステム日時を設定

#### トレーニング記録
指定されたidに一致するものを物理削除する

#### エラーハンドリング
- データ不整合の場合：400 Bad Request エラー原因をメッセージで返す

## パフォーマンス計測と監視

- RUM(Real User Monitoring)を導入してFCP等を計測
- CIで簡易パフォーマンステストを実行（ベンチマーク）
- 障害発生時のログ集約: ログは外部のログサービスへ送信（例: Logflare/Supabase Logs等）

## バックアップと復元

- Supabaseのスナップショット/バックアップ手順を定期的に実行
- 復元手順をドキュメント化してリハーサルを行う

## セキュリティとコンプライアンス

- データは転送時/保存時に暗号化
- 最低限のアクセス権原則（最小権限）を適用
- 脆弱性スキャン（Dependabot等）を導入

## マイグレーション方針

- スキーマ変更は `data-model.md` の更新 + マイグレーションスクリプトをPRに含める
- 互換性を保つためにローリングアップデートや後方互換レイヤを検討

## テスト計画

- ユニットテスト: ロジックの単体検証
- 統合テスト: DBや外部サービスとの結合検証
- E2E: ユーザージャーニーをブラウザベースで検証

---

この計画は `spec.md` の要件を実装するための実務的なガイドラインを示します。変更がある場合は `spec.md` と `plan.md` の両方を更新してください。
